#!/bin/bash
EMAIL_NUM=$(grep "$(date -d today +%b\ %e)" /var/log/mail.log | grep 'to=<' | wc -l | sort -nr);POSTFIX_STATUS=$(service postfix status | grep active | awk {'print $02'}); if [[ $POSTFIX_STATUS = "active" ]]; then echo ""; echo "Emails sent today: $EMAIL_NUM"; echo "================="; cd /var/log; grep postfix syslog | grep Subject | awk '{for (i = 1; i < 9; i++) $i = ""; sub(/^ */, ""); print}' | awk '{$NF=""; print $0}' | awk '{$NF=""; print $0}' | awk '{$NF=""; print $0}' | sort | uniq -c | sort -nr; USERDIR=$(ls /www | grep -e .*\_.*);echo ""; echo "Tail $EMAIL_NUM POST URLs"; echo "================="; grep -i "POST" /www/$USERDIR/logs/access.log | tail -n$EMAIL_NUM | awk {'print $06, $09'} | sort | uniq -c | sort -nr | head -n10; else EMAIL_NUM1=$(grep "$(date -d today +%b\ %e)" /var/log/mail.log | grep 'to=<' | wc -l); echo ""; EMAIL_QNUM=$(postqueue -p | grep -o '^[0-9A-F]*' | xargs postcat -q | grep Subject | sort | wc -l); echo "Mail Queue: $EMAIL_QNUM"; echo "==========";echo ""; echo "Top 10 Subjects in the queue"; echo "============================"; postqueue -p | grep -o '^[0-9A-F]*' | xargs postcat -q | grep Subject | sort | uniq -c | sort -nr | head -n10; echo ""; echo Emails sent today: $EMAIL_NUM1; echo "================"; cd /var/log; grep postfix syslog | grep Subject | awk '{for (i = 1; i < 9; i++) $i = ""; sub(/^ */, ""); print}' | awk '{$NF=""; print $0}' | awk '{$NF=""; print $0}' | awk '{$NF=""; print $0}' | sort | uniq -c | sort -nr && EMAIL_NUM=$(grep "$(date -d today +%b\ %e)" /var/log/mail.log | grep 'to=<' | wc -l); USERDIR=$(ls /www | grep -e .*\_.*);echo ""; echo "Tail $EMAIL_NUM POST URLs"; echo "================"; grep -i "POST" /www/$USERDIR/logs/access.log | tail -n$EMAIL_NUM | awk {'print $06, $09'} | sort | uniq -c | sort -nr | head -n10; fi; echo ""; echo "IPs of POSTs above"; echo "=================="; POST_URLS=$(grep -i "POST" /www/$USERDIR/logs/access.log | tail -n$EMAIL_NUM | awk {'print $06'} | sort | uniq -c | sort -nr | head -n10 | awk '{print}' ORS='\\|'); grep -i "$POST_URLS" /www/$USERDIR/logs/access.log | grep POST | tail -n$EMAIL_NUM | awk {'print $02'} | sort | uniq -c | sort -nr | head -n15
